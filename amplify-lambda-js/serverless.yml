service: amplify-${self:custom.depName}-amplify-js
frameworkVersion: '3'

plugins:
  - serverless-offline
  - serverless-prune-plugin
  - serverless-cloudformation-changesets

layers:
  pythonLiteLLM:
    path: litellm-layer
    name: ${self:service}-${sls:stage}-python-litellm
    description: Python 3.11 runtime with LiteLLM and boto3 for Node.js Lambda
    compatibleRuntimes:
      - nodejs22.x

custom:
  stageVars: ${file(../var/${self:provider.stage}-var.yml)}
  depName: ${self:custom.stageVars.DEP_NAME}

  serverless-offline: 
    custom:
      config: ${file(../var/${self:provider.stage}-var.yml)} 
 

  cf-changesets:
    requireChangeSet: ${ssm:/amplify/${sls:stage}/CHANGE_SET_BOOLEAN}

  stages:
    - dev
    - staging
    - prod

  # Base paths for Parameter Store
  ssmBasePath: /amplify/${sls:stage}/amplify-${self:custom.depName}
    
  prune:
    automatic: true
    includeLayers: true
    number: 5    


provider:
  name: aws
  runtime: nodejs22.x
  stage: ${opt:stage, 'dev'}
  region: ${self:custom.stageVars.DEP_REGION}
  versionFunctions: false
  logRetentionInDays: 365
  tracing:
    lambda: true
  apiGateway:
    restApiId:
      Fn::ImportValue: !Sub "${sls:stage}-RestApiId"
    restApiRootResourceId:
      Fn::ImportValue: !Sub "${sls:stage}-RestApiRootResourceId"   

  environment:
    CHANGE_SET_BOOLEAN: ${self:custom.stageVars.CHANGE_SET_BOOLEAN}
    LOG_LEVEL: ${self:custom.stageVars.LOG_LEVEL}
    
    AGENT_ENDPOINT: ${ssm:/amplify/${sls:stage}/AGENT_ENDPOINT}
    API_BASE_URL: https://${ssm:/amplify/${sls:stage}/CUSTOM_API_DOMAIN}
    BEDROCK_GUARDRAIL_ID: ${ssm:/amplify/${sls:stage}/BEDROCK_GUARDRAIL_ID, ''}
    BEDROCK_GUARDRAIL_VERSION: ${ssm:/amplify/${sls:stage}/BEDROCK_GUARDRAIL_VERSION, ''}
    COGNITO_CLIENT_ID: ${ssm:/amplify/${sls:stage}/COGNITO_CLIENT_ID}
    COGNITO_USER_POOL_ID: ${ssm:/amplify/${sls:stage}/COGNITO_USER_POOL_ID}
    DEP_REGION: ${ssm:/amplify/${sls:stage}/DEP_REGION} 
    IDP_PREFIX: ${ssm:/amplify/${sls:stage}/IDP_PREFIX}
    LLM_ENDPOINTS_SECRETS_NAME_ARN: ${ssm:/amplify/${sls:stage}/LLM_ENDPOINTS_SECRETS_NAME_ARN}
    LLM_ENDPOINTS_SECRETS_NAME: ${ssm:/amplify/${sls:stage}/LLM_ENDPOINTS_SECRETS_NAME}
    SECRETS_ARN_NAME: ${ssm:/amplify/${sls:stage}/SECRETS_ARN_NAME}
    TRACING_ENABLED: false
    SERVICE_NAME: ${self:service}
    STAGE: ${sls:stage}

    # Locally Defined Variables
    COST_CALCULATIONS_DYNAMO_TABLE: amplify-${self:custom.depName}-lambda-${sls:stage}-cost-calculations
    DATASOURCE_REGISTRY_DYNAMO_TABLE: ${self:service}-${sls:stage}-datasource-registry
    HISTORY_COST_CALCULATIONS_DYNAMO_TABLE: amplify-${self:custom.depName}-lambda-${sls:stage}-history-cost-calculations
    LAMBDA_JS_IAM_POLICY_NAME: ${self:service}-${sls:stage}-iam-policy
    REQUEST_STATE_DYNAMO_TABLE: ${self:service}-${sls:stage}-request-state
    TRACE_BUCKET_NAME: amplify-${self:custom.depName}-lambda-${sls:stage}-chat-traces
    CONVERSATION_ANALYSIS_QUEUE_URL: ${self:service}-${sls:stage}-conversation-analysis
  
    # Imported Variables from Parameter Store
    AMPLIFY_ADMIN_DYNAMODB_TABLE: ${ssm:${self:custom.ssmBasePath}-admin/AMPLIFY_ADMIN_DYNAMODB_TABLE}
    API_KEYS_DYNAMODB_TABLE: ${ssm:${self:custom.ssmBasePath}-object-access/API_KEYS_DYNAMODB_TABLE}
    ASSISTANT_GROUPS_DYNAMO_TABLE: ${ssm:${self:custom.ssmBasePath}-object-access/ASSISTANT_GROUPS_DYNAMO_TABLE}
    ASSISTANT_LOOKUP_DYNAMODB_TABLE: ${ssm:${self:custom.ssmBasePath}-assistants/ASSISTANT_LOOKUP_DYNAMODB_TABLE}
    ASSISTANTS_ALIASES_DYNAMODB_TABLE: ${ssm:${self:custom.ssmBasePath}-assistants/ASSISTANTS_ALIASES_DYNAMODB_TABLE}
    ASSISTANTS_DYNAMODB_TABLE: ${ssm:${self:custom.ssmBasePath}-assistants/ASSISTANTS_DYNAMODB_TABLE}
    CHAT_USAGE_DYNAMO_TABLE: ${ssm:${self:custom.ssmBasePath}-lambda/CHAT_USAGE_DYNAMO_TABLE}
    ENV_VARS_TRACKING_TABLE: ${ssm:${self:custom.ssmBasePath}-lambda/ENV_VARS_TRACKING_TABLE}
    GROUP_ASSISTANT_CONVERSATIONS_DYNAMO_TABLE: ${ssm:${self:custom.ssmBasePath}-assistants/GROUP_ASSISTANT_CONVERSATIONS_DYNAMO_TABLE}
    HASH_FILES_DYNAMO_TABLE: ${ssm:${self:custom.ssmBasePath}-lambda/HASH_FILES_DYNAMO_TABLE}
    MODEL_RATE_TABLE: ${ssm:${self:custom.ssmBasePath}-chat-billing/MODEL_RATE_TABLE}
    S3_CONSOLIDATION_BUCKET_NAME: ${ssm:${self:custom.ssmBasePath}-lambda/S3_CONSOLIDATION_BUCKET_NAME}
    S3_FILE_TEXT_BUCKET_NAME: ${ssm:${self:custom.ssmBasePath}-lambda/S3_FILE_TEXT_BUCKET_NAME}
    S3_GROUP_ASSISTANT_CONVERSATIONS_BUCKET_NAME: ${ssm:${self:custom.ssmBasePath}-assistants/S3_GROUP_ASSISTANT_CONVERSATIONS_BUCKET_NAME} # Marked for future deletion
    S3_IMAGE_INPUT_BUCKET_NAME: ${ssm:${self:custom.ssmBasePath}-lambda/S3_IMAGE_INPUT_BUCKET_NAME}
    S3_RAG_INPUT_BUCKET_NAME: ${ssm:${self:custom.ssmBasePath}-lambda/S3_RAG_INPUT_BUCKET_NAME}
    AGENT_STATE_DYNAMODB_TABLE: ${ssm:${self:custom.ssmBasePath}-agent-loop/AGENT_STATE_DYNAMODB_TABLE}

  iam:
    role:
      managedPolicies:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - !Ref LambdaJSIAMPolicy
        - !Ref BedrockIAMPolicy
        #- arn:aws:iam::${aws:accountId}:policy/${self:provider.environment.LAMBDA_JS_IAM_POLICY_NAME}


functions:
  chat:
    handler: index.handler
    memorySize: 1024
    timeout: 900
    tracing: Active
    layers:
      - !Ref PythonLiteLLMLambdaLayer
    url:
      cors: true
      invokeMode: RESPONSE_STREAM

  api_g_chat:
    handler: indexApiG.handler
    memorySize: 1024
    timeout: 180
    events:
      - http:
          path: api_g_chat/chat
          method: post
          cors: true


  reset_billing:
    handler: billing/reset.handler
    memorySize: 512 # increased memory size to increase speed
    timeout: 900 # 900 seconds (15 minutes) is the maximum
    events:
      - schedule:
          rate: cron(0 0 * * ? *) # trigger at midnight UTC every day

  # provides real-time usage information via API gateway
  mtd_cost_reporter:
    handler: billing/mtd.handler
    memorySize: 128
    events:
      - http:
          path: billing/mtd-cost
          method: post
          cors: true

  api_key_user_cost:
    handler: billing/mtd.apiKeyUserCostHandler
    memorySize: 128
    events:
      - http:
          path: billing/api-key-user-cost
          method: post
          cors: true

  billing_groups_costs:
    handler: billing/mtd.billingGroupsCostsHandler
    memorySize: 256
    timeout: 60
    events:
      - http:
          path: billing/billing-groups-costs
          method: post
          cors: true

  list_all_user_mtd_costs:
    handler: billing/mtd.listAllUserMtdCostsHandler
    memorySize: 128
    events:
      - http:
          path: billing/list-all-user-mtd-costs
          method: post
          cors: true
        
  list_user_mtd_costs:
    handler: billing/mtd.listUserMtdCostsHandler
    memorySize: 128
    events:
      - http:
          path: billing/list-user-mtd-costs
          method: post
          cors: true

  conversation_analysis_processor:
    handler: groupassistants/conversationAnalysis.sqsProcessorHandler
    memorySize: 512
    timeout: 300
    events:
      - sqs:
          arn: !GetAtt ConversationAnalysisQueue.Arn
          batchSize: 1
          maximumBatchingWindowInSeconds: 5


resources:
  Resources:
    LambdaJSIAMPolicy:
      Type: AWS::IAM::ManagedPolicy
      Properties:
        ManagedPolicyName: ${self:provider.environment.LAMBDA_JS_IAM_POLICY_NAME}
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - s3:GetObject
                - s3:PutObject
                - s3:ListBucket
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:Query 
                - dynamodb:UpdateItem
                - dynamodb:Scan
                - sqs:SendMessage
                - sqs:DeleteMessage
                - sqs:GetQueueAttributes
                - sqs:ReceiveMessage
                - bedrock:InvokeModelWithResponseStream
                - bedrock:InvokeModel
              Resource:
                - '${self:provider.environment.LLM_ENDPOINTS_SECRETS_NAME_ARN}'
                - "arn:aws:secretsmanager:${aws:region}:*:secret:${self:provider.environment.SECRETS_ARN_NAME}*"
                - "arn:aws:s3:::${self:provider.environment.S3_FILE_TEXT_BUCKET_NAME}/*"
                - "arn:aws:s3:::${self:provider.environment.S3_IMAGE_INPUT_BUCKET_NAME}/*"
                - "arn:aws:s3:::${self:provider.environment.TRACE_BUCKET_NAME}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANT_GROUPS_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANT_GROUPS_DYNAMO_TABLE}/*"
                # Marked for future deletion
                - "arn:aws:s3:::${self:provider.environment.S3_GROUP_ASSISTANT_CONVERSATIONS_BUCKET_NAME}"
                - "arn:aws:s3:::${self:provider.environment.S3_GROUP_ASSISTANT_CONVERSATIONS_BUCKET_NAME}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.CHAT_USAGE_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.CHAT_USAGE_DYNAMO_TABLE}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.API_KEYS_DYNAMODB_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.API_KEYS_DYNAMODB_TABLE}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.REQUEST_STATE_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.HASH_FILES_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.COST_CALCULATIONS_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.COST_CALCULATIONS_DYNAMO_TABLE}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.HISTORY_COST_CALCULATIONS_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.HISTORY_COST_CALCULATIONS_DYNAMO_TABLE}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.MODEL_RATE_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.MODEL_RATE_TABLE}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.GROUP_ASSISTANT_CONVERSATIONS_DYNAMO_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.GROUP_ASSISTANT_CONVERSATIONS_DYNAMO_TABLE}/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.AMPLIFY_ADMIN_DYNAMODB_TABLE}"
                - 'arn:aws:bedrock:*::foundation-model/*'
                - "arn:aws:bedrock:*:${aws:accountId}:inference-profile/*"
                - "arn:aws:s3:::${self:provider.environment.S3_CONSOLIDATION_BUCKET_NAME}"
                - "arn:aws:s3:::${self:provider.environment.S3_CONSOLIDATION_BUCKET_NAME}/*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANTS_ALIASES_DYNAMODB_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANTS_DYNAMODB_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANTS_DYNAMODB_TABLE}/index/*"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.AGENT_STATE_DYNAMODB_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANT_LOOKUP_DYNAMODB_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ASSISTANT_LOOKUP_DYNAMODB_TABLE}/index/*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.DATASOURCE_REGISTRY_DYNAMO_TABLE}"
            - Effect: Allow
              Action:
                - dynamodb:DeleteItem
              Resource:
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.REQUEST_STATE_DYNAMO_TABLE}"
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource:
                - "arn:aws:s3:::${self:provider.environment.S3_RAG_INPUT_BUCKET_NAME}/*"
            - Effect: Allow
              Action:
                - bedrock:InvokeGuardrail
                - bedrock:ApplyGuardrail
              Resource:
                - "arn:aws:bedrock:*:${aws:accountId}:guardrail/${self:provider.environment.BEDROCK_GUARDRAIL_ID, '*'}"
                - "arn:aws:bedrock:*:${aws:accountId}:guardrail-profile/*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource:
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ENV_VARS_TRACKING_TABLE}"
                - "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.ENV_VARS_TRACKING_TABLE}/index/*"
                - !GetAtt ConversationAnalysisQueue.Arn
            - Effect: Allow
              Action:
                - ssm:GetParameter
                - ssm:GetParameters
                - ssm:GetParametersByPath
              Resource:
                - arn:aws:ssm:${self:provider.region}:${aws:accountId}:parameter${self:custom.ssmBasePath}-*   
    
    RequestStateDynamoDbTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        AttributeDefinitions:
          -
            AttributeName: requestId
            AttributeType: S
          -
            AttributeName: user
            AttributeType: S
        KeySchema:
          -
            AttributeName: user
            KeyType: HASH
          -
            AttributeName: requestId
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        TableName: ${self:provider.environment.REQUEST_STATE_DYNAMO_TABLE}
    DatasourceRegistryDynamoDbTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        AttributeDefinitions:
          -
            AttributeName: type
            AttributeType: S
        KeySchema:
          -
            AttributeName: type
            KeyType: HASH
        TableName: ${self:provider.environment.DATASOURCE_REGISTRY_DYNAMO_TABLE}
    CostCalculationsDynamoDbTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: accountInfo
            AttributeType: S
          - AttributeName: record_type
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
          - AttributeName: accountInfo
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: record-type-user-index
            KeySchema:
              - AttributeName: record_type
                KeyType: HASH
              - AttributeName: id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TableName: ${self:provider.environment.COST_CALCULATIONS_DYNAMO_TABLE}
    HistoryCostCalculationsDynamoDbTable:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        AttributeDefinitions:
          - AttributeName: userDate
            AttributeType: S
          - AttributeName: accountInfo
            AttributeType: S
          - AttributeName: record_type
            AttributeType: S
        KeySchema:
          - AttributeName: userDate
            KeyType: HASH
          - AttributeName: accountInfo
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: record-type-user-index
            KeySchema:
              - AttributeName: record_type
                KeyType: HASH
              - AttributeName: userDate
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TableName: ${self:provider.environment.HISTORY_COST_CALCULATIONS_DYNAMO_TABLE}
    ChatTracesBucket:
        Type: AWS::S3::Bucket
        Properties:
          BucketName: ${self:provider.environment.TRACE_BUCKET_NAME}

    ConversationAnalysisQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-conversation-analysis
        VisibilityTimeout: 360
        MessageRetentionPeriod: 1209600 # 14 days
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt ConversationAnalysisDeadLetterQueue.Arn
          maxReceiveCount: 3

    ConversationAnalysisDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-conversation-analysis-dlq
        MessageRetentionPeriod: 1209600 # 14 days

    BedrockIAMPolicy:
      Type: AWS::IAM::ManagedPolicy
      Properties:
        ManagedPolicyName: ${self:service}-${sls:stage}-bedrock-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModelWithResponseStream
                - bedrock:InvokeModel
              Resource:
                - 'arn:aws:bedrock:*::foundation-model/*'
                - !Sub arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/*
  Outputs:
    BedrockIAMPolicyArn:
      Value: 
        Ref: BedrockIAMPolicy
      Export:
        Name: ${self:service}-${sls:stage}-BedrockIAMPolicyArn