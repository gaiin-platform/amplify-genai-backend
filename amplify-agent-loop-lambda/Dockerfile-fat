FROM public.ecr.aws/lambda/python:3.11

# Install system dependencies
RUN yum -y update && \
    yum -y install \
        gcc gcc-c++ make \
        libffi-devel \
        cairo-devel \
        gobject-introspection-devel \
        glib2-devel \
        xz \
        git \
        wget \
        unzip \
        tar \
        curl \
        which \
        python3 \
        python3-devel \
        ImageMagick \
        poppler-utils \
        xpdf \
        libGL \
        && yum clean all

RUN yum -y install xz && \
    curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz && \
    tar -xf ffmpeg.tar.xz && \
    dir=$(find . -maxdepth 1 -type d -name "ffmpeg-*-static") && \
    cp "$dir/ffmpeg" /usr/bin/ffmpeg && \
    cp "$dir/ffprobe" /usr/bin/ffprobe && \
    chmod +x /usr/bin/ffmpeg /usr/bin/ffprobe && \
    rm -rf "$dir" ffmpeg.tar.xz

# Install Pandoc (static binary)
RUN curl -L https://github.com/jgm/pandoc/releases/download/3.2/pandoc-3.2-linux-amd64.tar.gz -o pandoc.tar.gz && \
    tar -xzf pandoc.tar.gz && \
    cp -r pandoc-3.2/bin/* /usr/local/bin/ && \
    rm -rf pandoc*


RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash && \
    export NVM_DIR="$HOME/.nvm" && \
    . "$NVM_DIR/nvm.sh" && \
    nvm install 16 && \
    nvm use 16 && \
    npm install -g markitdown && \
    ln -s "$NVM_DIR/versions/node/v16.*/bin/markitdown" /usr/local/bin/markitdown

# Upgrade pip
RUN pip install --upgrade pip

# Install Lambda Runtime Interface Client (NOT needed unless using custom entrypoint)
# RUN pip install awslambdaric  ‚Üê REMOVE this

# Set working directory
WORKDIR /var/task

# Copy and install Python dependencies
COPY requirements.txt agent-requirements-fat.txt ./
RUN pip install --no-cache-dir -r requirements.txt -r agent-requirements-fat.txt

# Copy application code
COPY . .

# Let AWS Lambda handle RIC
CMD ["service.core.route"]